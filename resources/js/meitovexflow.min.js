/*! meitovexflow 2014-03-20 */
var MeiLib={};MeiLib.RuntimeError=function(errorcode,message){this.errorcode=errorcode,this.message=message},MeiLib.RuntimeError.prototype.toString=function(){return"MeiLib.RuntimeError: "+this.errorcode+": "+this.message?this.message:""},MeiLib.createPseudoUUID=function(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).substr(-4)},MeiLib.EventEnumerator=function(node){this.init(node)},MeiLib.EventEnumerator.prototype.init=function(node){if(!node)throw new MeiLib.RuntimeError("MeiLib.EventEnumerator.init():E01","node is null or undefined");this.node=node,this.next_evnt=null,this.EoI=!0,this.children=$(this.node).children(),this.i_next=-1,this.read_ahead()},MeiLib.EventEnumerator.prototype.nextEvent=function(){if(!this.EoI){var result=this.next_evnt;return this.read_ahead(),result}throw new MeiLib.RuntimeError("MeiLib.LayerEnum:E01","End of Input.")},MeiLib.EventEnumerator.prototype.read_ahead=function(){this.beam_enumerator?this.beam_enumerator.EoI?(this.EoI=!0,this.beam_enumerator=null,this.step_ahead()):(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1):this.step_ahead()},MeiLib.EventEnumerator.prototype.step_ahead=function(){if(++this.i_next,this.i_next<this.children.length){this.next_evnt=this.children[this.i_next];var node_name=$(this.next_evnt).prop("localName");"note"===node_name||"rest"===node_name||"mRest"===node_name||"chord"===node_name?this.EoI=!1:"beam"===node_name&&(this.beam_enumerator=new MeiLib.EventEnumerator(this.next_evnt),this.beam_enumerator.EoI?this.EoI=!0:(this.next_evnt=this.beam_enumerator.nextEvent(),this.EoI=!1))}else this.EoI=!0},MeiLib.durationOf=function(evnt,meter){IsSimpleEvent=function(tagName){return"note"===tagName||"rest"===tagName||"space"===tagName};var durationOf_SimpleEvent=function(simple_evnt,meter){var dur=$(simple_evnt).attr("dur");if(!dur)throw new MeiLib.RuntimeError("MeiLib.durationOf:E04","@dur of <note>, <rest> or <space> must be specified.");return MeiLib.dotsMult(simple_evnt)*MeiLib.dur2beats(Number(dur),meter)},durationOf_Chord=function(chord,meter,layer_no){layer_no||(layer_no="1");var dur=$(chord).attr("dur"),dotsMult=MeiLib.dotsMult(chord);if(dur)return dotsMult*MeiLib.dur2beats(Number(dur),meter);if($(chord).find("note").each(function(){if(lyr_n=$(this).attr("layer"),!lyr_n||lyr_n===layer_no){var dur_note=$(this).attr("dur"),dotsMult_note=MeiLib.dotsMult(chord);if(!dur&&dur_note)dur=dur_note,dotsMult=dotsMult_note;else if(dur&&dur!=dur_note)throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","duration of <chord> is ambiguous.")}}),dur)return dotsMult*MeiLib.dur2beats(Number(dur),meter);throw new MeiLib.RuntimeError("MeiLib.durationOf:E06","@dur of chord must be specified either in <chord> or in at least one of its <note> elements.")},durationOf_Beam=function(beam,meter){var acc=0;return beam.children().each(function(){var dur_b,tagName=this.prop("localName");if(IsSimpleEvent(tagName))dur_b=durationOf_SimpleEvent(this,meter);else{if("chord"!==tagName)throw new MeiLib.RuntimeError("MeiLib.durationOf:E03","Not supported element '"+tagName+"'");dur_b=durationOf_Chord(this,meter)}acc+=dur_b}),acc},evnt_name=$(evnt).prop("localName");if(IsSimpleEvent(evnt_name))return durationOf_SimpleEvent(evnt,meter);if("mRest"===evnt_name)return meter.count;if("chord"===evnt_name)return durationOf_Chord(evnt,meter);if("beam"===evnt_name)return durationOf_Beam(evnt,meter);throw new MeiLib.RuntimeError("MeiLib.durationOf:E05","Not supported element: '"+evnt_name+"'")},MeiLib.tstamp2id=function(tstamp,layer,meter){for(var evnt,dist,prev_evnt,prev_dist,ts=Number(tstamp),ts_acc=0,c_ts=function(){return ts_acc+1},distF=function(){return ts-c_ts()},eventList=new MeiLib.EventEnumerator(layer);!eventList.EoI&&(void 0===dist||dist>0);)prev_evnt=evnt,prev_dist=dist,evnt=eventList.nextEvent(),dist=distF(),ts_acc+=MeiLib.durationOf(evnt,meter);if(void 0===dist)return void 0;var winner;winner=0>dist&&prev_evnt&&prev_dist<Math.abs(dist)?prev_evnt:evnt;var xml_id;return xml_id=$(winner).attr("xml:id"),xml_id||(xml_id=MeiLib.createPseudoUUID(),$(winner).attr("xml:id",xml_id)),xml_id},MeiLib.XMLID=function(elem){return xml_id=$(elem).attr("xml:id"),xml_id||(xml_id=MeiLib.createPseudoUUID(),$(elem).attr("xml:id",xml_id)),xml_id},MeiLib.id2tstamp=function(eventid,context){for(var meter,found=!1,i=0;i<context.length&&!found;++i){if(context[i].meter&&(meter=context[i].meter),0===i&&!meter)throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E001","No time signature specified");var result=MeiLib.sumUpUntil(eventid,context[i].layer,meter);if(result.found)return found=!0,i.toString()+"m+"+(result.beats+1).toString()}throw new MeiLib.RuntimeError("MeiLib.id2tstamp:E002",'No event with xml:id="'+eventid+'" was found in the given MEI context.')},MeiLib.dur2beats=function(dur,meter){return meter.unit/dur},MeiLib.beats2dur=function(beats,meter){return meter.unit/beats},MeiLib.dotsMult=function(node){var dots=$(node).attr("dots");dots=Number(dots||"0");for(var mult=1;dots>0;--dots)mult+=1/Math.pow(2,dots);return mult},MeiLib.sumUpUntil=function(eventid,layer,meter){var sumUpUntil_inNode=function(node_elem){var node=$(node_elem),node_name=node.prop("localName");if("note"===node_name||"rest"===node_name){if(node.attr("xml:id")===eventid)return{beats:0,found:!0};var dur=Number(node.attr("dur"));if(!dur)throw new MeiLib.RuntimeError("MeiLib.sumUpUntil:E001","Duration is not a number ('breve' and 'long' are not supported).");var dots=node.attr("dots");dots=Number(dots||"0");var beats=MeiLib.dotsMult(node)*MeiLib.dur2beats(dur,meter);return{beats:beats,found:!1}}if("mRest"===node_name)return node.attr("xml:id")===eventid?(found=!0,{beats:0,found:!0}):{beats:meter.count,found:!1};if("layer"===node_name||"beam"===node_name){for(var beats=0,children=node.children(),found=!1,i=0;i<children.length&&!found;++i){var subtotal=sumUpUntil_inNode(children[i]);beats+=subtotal.beats,found=subtotal.found}return{beats:beats,found:found}}if("chord"===node_name){var chord_dur=node.attr("dur");if(node.attr("xml:id")===eventid)return{beats:0,found:!0};var chord_dur=node.attr("dur");if(chord_dur)return node.find("[xml\\:id='"+eventid+"']").length?{beats:0,found:!0}:{beats:MeiLib.dur2beats(chord_dur,meter),found:found};for(var children=node.children(),found=!1,i=0;i<children.length&&!found;++i){var subtotal=sumUpUntil_inNode(children[i]);beats=subtotal.beats,found=subtotal.found}return{beats:beats,found:found}}return{beats:0,found:!1}};return sumUpUntil_inNode(layer)},MeiLib.SliceMEI=function(MEI,params){var setVisibles=function(elements,params){$.each(elements,function(i,elem){params.noClef&&$(elem).attr("clef.visible","false"),params.noKey&&$(elem).attr("key.sig.show","false"),params.noMeter&&$(elem).attr("meter.rend","false")})},paramsStaves=params.staves;if(paramsStaves)for(var staffDefSelector="",staffNSelector="",commaspace="",i=0;i<paramsStaves.length;i++)staffDefSelector+=commaspace+'[n="'+paramsStaves[i]+'"]',staffNSelector+=commaspace+'[staff="'+paramsStaves[i]+'"]',0===i&&(commaspace=", ");var scoreDefs,slice=MEI.cloneNode(!0);if(paramsStaves&&$(slice).find("staffDef").remove(":not("+staffDefSelector+")"),params.noClef||params.noKey||params.noMeter){var staffDefs=$(slice).find("staffDef"),scoreDefs=$(slice).find("scoreDef");setVisibles(scoreDefs,params),setVisibles(staffDefs,params)}params.noConnectors&&$(slice).find("staffGrp").removeAttr("symbol");var section=$(slice).find("section")[0],inside_slice=!1,found=!1,section_children=section.childNodes;return $(section_children).each(function(){var child=this;if(inside_slice||("measure"===child.localName&&Number($(child).attr("n"))===params.start_n?(inside_slice=!0,found=!0):section.removeChild(child)),inside_slice){if(paramsStaves){$(child).find("[staff]").remove(":not("+staffNSelector+")");var staves=$(child).find("staff");$(staves).each(function(){var staff=this;if(-1===$.inArray(Number($(staff).attr("n")),paramsStaves)){var parent=this.parentNode;parent.removeChild(this)}})}"measure"===child.localName&&Number($(child).attr("n"))===params.end_n&&(inside_slice=!1)}}),slice},MeiLib.Alt=function(xmlID,parentID){this.xmlID=xmlID,this.altitems=[],this.parentID=parentID},MeiLib.Variant=function(xmlID,tagname,source,resp,n){this.xmlID=xmlID,this.tagname=tagname,this.source=source,this.resp=resp,this.n=n},MeiLib.MeiDoc=function(meiXmlDoc){meiXmlDoc&&this.init(meiXmlDoc)},MeiLib.MeiDoc.prototype.init=function(meiXmlDoc){this.xmlDoc=meiXmlDoc,this.rich_head=meiXmlDoc.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","meiHead")[0],this.rich_music=meiXmlDoc.getElementsByTagNameNS("http://www.music-encoding.org/ns/mei","music")[0],this.rich_score=$(this.rich_music).find("score")[0],this.parseSourceList(),this.parseEditorList(),this.parseALTs(),this.initAltgroups(),this.initSectionView()},MeiLib.MeiDoc.prototype.getRichScore=function(){return this.rich_score},MeiLib.MeiDoc.prototype.getPlainScore=function(){return this.plain_score},MeiLib.MeiDoc.prototype.getALTs=function(){return this.ALTs},MeiLib.MeiDoc.prototype.getSourceList=function(){return this.sourceList},MeiLib.MeiDoc.prototype.getEditorList=function(){return this.editorList},MeiLib.MeiDoc.prototype.parseSourceList=function(){return this.sources=$(this.rich_head).find("sourceDesc").children(),this.sources},MeiLib.MeiDoc.prototype.parseEditorList=function(){return this.editors=$(this.rich_head).find("titleStmt").children("editor"),this.editors},MeiLib.MeiDoc.prototype.parseALTs=function(){this.ALTs={};for(var apps=$(this.rich_score).find("app, choice"),i=0;i<apps.length;i++){var app=apps[i],parent=app.parentNode,altitems=$(app).find("rdg, lem, sic, corr"),AppsItem=new MeiLib.Alt(MeiLib.XMLID(app),MeiLib.XMLID(parent));AppsItem.altitems={};for(var j=0;j<altitems.length;j++){var altitem=altitems[j],source=$(altitem).attr("source"),resp=$(altitem).attr("resp"),n=$(altitem).attr("n"),tagname=$(altitem).prop("localName"),varXMLID=MeiLib.XMLID(altitem);AppsItem.altitems[varXMLID]=new MeiLib.Variant(varXMLID,tagname,source,resp,n)}this.ALTs[MeiLib.XMLID(app)]=AppsItem}},MeiLib.MeiDoc.prototype.initAltgroups=function(){this.ALTs;annots=$(this.rich_score).find('annot[type="appGrp"], annot[type="choiceGrp"]'),this.altgroups={};for(var i=0;i<annots.length;i++){altgroup=[],token_list=$(annots[i]).attr("plist").split(" ");for(var j=0;j<token_list.length;j++)altgroup.push(token_list[j].replace("#",""));for(var j in altgroup)this.altgroups[altgroup[j]]=altgroup}},MeiLib.MeiDoc.prototype.initSectionView=function(altReplacements){altReplacements=altReplacements||{},this.sectionview_score=this.rich_score.cloneNode(!0),this.sectionplane={};var alt_instance2insert,alt_item_xml_id,alts=$(this.sectionview_score).find("app, choice"),this_sectionplane=(this.sectionview_score,this.sectionplane),this_ALTs=this.ALTs,xmlDoc=this.xmlDoc;return $(alts).each(function(i,alt){var alt_xml_id=MeiLib.XMLID(alt),replacement=altReplacements[alt_xml_id];if(replacement){alt_item_xml_id=replacement.xmlID;var alt_item=$(this_score).find(replacement.tagname+'[xml\\:id="'+alt_item_xml_id+'"]')[0];if(!alt_item)throw new MeiLib.RuntimeError("MeiLib.MeiDoc.prototype.initSectionView():E01","Cannot find <lem>, <rdg>, <sic>, or <corr> with @xml:id '"+alt_item_xml_id+"'.");alt_instance2insert=alt_item.childNodes}else if("choice"===alt.localName){var corr=$(alt).find("corr")[0];if(corr)alt_item_xml_id=MeiLib.XMLID(corr),alt_instance2insert=corr.childNodes;else{var sic=$(alt).find("sic")[0];sic?(alt_item_xml_id=MeiLib.XMLID(sic),alt_instance2insert=sic.childNodes):alt_instance2insert=[]}}else{var lem=$(alt).find("lem")[0];lem?(alt_item_xml_id=MeiLib.XMLID(lem),alt_instance2insert=lem.childNodes):alt_instance2insert=[]}var parent=alt.parentNode,PIStart=xmlDoc.createProcessingInstruction("MEI2VF",'rdgStart="'+alt_xml_id+'"');parent.insertBefore(PIStart,alt),$.each(alt_instance2insert,function(){parent.insertBefore(this.cloneNode(!0),alt)});var PIEnd=xmlDoc.createProcessingInstruction("MEI2VF",'rdgEnd="'+alt_xml_id+'"');parent.insertBefore(PIEnd,alt),parent.removeChild(alt),this_sectionplane[alt_xml_id]=this_ALTs[alt_xml_id].altitems[alt_item_xml_id]}),this.sectionview_score},MeiLib.MeiDoc.prototype.updateSectionView=function(sectionplaneUpdate){var corresponding_alt_item=function(altitems,altitem){var corresponding_item,vars_match=function(v1,v2){var res=0;for(var field in v1)void 0!==v1[field]&&v1[field]===v2[field]&&res++;return console.log("vars_match: "+res),res},max=0;for(var alt_item_id in altitems)M=vars_match(altitems[alt_item_id],altitem),M>max&&(max=M,corresponding_item=altitems[alt_item_id]);return corresponding_item};for(altID in sectionplaneUpdate){var alt_instance2insert=this.ALTs[altID].altitems[sectionplaneUpdate[altID]];if(altgroup=this.altgroups[altID]){var i;for(i=0;i<altgroup.length;i++)altID__=altgroup[i],alt_instance2insert__=corresponding_alt_item(this.ALTs[altID__].altitems,alt_instance2insert),this.replaceAltInstance({appXmlID:altID__,replaceWith:alt_instance2insert__})}else this.replaceAltInstance({appXmlID:altID,replaceWith:alt_instance2insert})}},MeiLib.MeiDoc.prototype.replaceAltInstance=function(alt_inst_update){var app_xml_id=alt_inst_update.appXmlID,alt_instance2insert=[];if(alt_inst_update.replaceWith){var replaceWith_xmlID=alt_inst_update.replaceWith.xmlID,var_inst_elem=$(this.rich_score).find(alt_inst_update.replaceWith.tagname+'[xml\\:id="'+replaceWith_xmlID+'"]')[0];alt_instance2insert=var_inst_elem.childNodes}var match_pseudo_attrValues=function(data1,data2){return data1=data1.replace("'",'"'),data2=data2.replace("'",'"'),data1===data2},parent=$(this.sectionview_score).find("[xml\\:id="+this.ALTs[app_xml_id].parentID+"]")[0],children=parent.childNodes,inside_inst=!1,found=!1,insert_before_this=null;if($(children).each(function(){var child=this;7===child.nodeType?"MEI2VF"===child.nodeName&&match_pseudo_attrValues(child.nodeValue,'rdgStart="'+app_xml_id+'"')?(inside_inst=!0,found=!0):"MEI2VF"===child.nodeName&&match_pseudo_attrValues(child.nodeValue,'rdgEnd="'+app_xml_id+'"')&&(inside_inst=!1,insert_before_this=child):inside_inst&&parent.removeChild(child)}),!found)throw"processing instruction not found";if(inside_inst)throw"Unmatched <?MEI2VF rdgStart?>";var insert_method;return insert_method=insert_before_this?function(elem){parent.insertBefore(elem,insert_before_this)}:function(elem){parent.appendChild(elem)},$.each(alt_instance2insert,function(){insert_method(this.cloneNode(!0))}),this.sectionplane[app_xml_id]=alt_inst_update.replaceWith,this.sectionview_score},MeiLib.MeiDoc.prototype.getSectionViewSlice=function(params){return MeiLib.SliceMEI(this.sectionview_score,params)},MeiLib.MeiDoc.prototype.getRichSlice=function(params){var slice=new MeiLib.MeiDoc;return slice.xmlDoc=this.xmlDoc,slice.rich_head=this.rich_head.cloneNode(),slice.rich_music=this.rich_music.cloneNode(),slice.rich_score=MeiLib.SliceMEI(this.rich_score,params),slice.sourceList=this.sourceList,slice.editorList=this.editorList,slice.ALTs=this.ALTs,slice.altgroups=this.altgroups,slice},mei2vexflowTables={},mei2vexflowTables.positions={above:Vex.Flow.Modifier.Position.ABOVE,below:Vex.Flow.Modifier.Position.BELOW},mei2vexflowTables.hairpins={cres:Vex.Flow.StaveHairpin.type.CRESC,dim:Vex.Flow.StaveHairpin.type.DECRESC},mei2vexflowTables.articulations={acc:"a>",stacc:"a.",ten:"a-",stacciss:"av",marc:"a^",dnbow:"am",upbow:"a|",snap:"ao",lhpizz:"a+",dot:"a.",stroke:"a|"},mei2vexflowTables.barlines={single:Vex.Flow.Barline.type.SINGLE,dbl:Vex.Flow.Barline.type.DOUBLE,end:Vex.Flow.Barline.type.END,rptstart:Vex.Flow.Barline.type.REPEAT_BEGIN,rptend:Vex.Flow.Barline.type.REPEAT_END,rptboth:Vex.Flow.Barline.type.REPEAT_BOTH,invis:Vex.Flow.Barline.type.NONE},Node.prototype.attrs=function(){var i,attrs={};for(i in this.attributes)attrs[this.attributes[i].name]=this.attributes[i].value;return attrs},Array.prototype.all=function(test){test=test||function(a){return 1==a};var i;for(i=0;i<this.length;i++)if(test(this[i])===!1)return!1;return!0},Array.prototype.any=function(test){test=test||function(a){return 1==a};var i;for(i=0;i<this.length;i++)if(test(this[i])===!0)return!0;return!1},MEI2VF={},MEI2VF.RUNTIME_ERROR=function(error_code,message){this.error_code=error_code,this.message=message},MEI2VF.RUNTIME_ERROR.prototype.toString=function(){return"MEI2VF.RUNTIME_ERROR: "+this.error_code+": "+this.message},MEI2VF.render_notation=function(score,target,width,height,backend){var n_measures,measure_width,context,width=width||800,ANNOT_FONT_SIZE=13,measures=[],measures_by_n=[],beams=[],notes=[],notes_by_id={},staves_by_n=[],ties=[],slurs=[],hairpins=[],unresolvedTStamp2=[],SYSTEM_SPACE=50,system_left=20,system_top=0,measure_left=system_left,bottom_most=0,system_n=0,nb_of_measures=0,system_break=!1,new_section=!0,staffInfoArray=new Array,staffDefList=[],staffXShift=0,staveConnectors={},staveVoices=new MEI2VF.StaveVoices,count_measures_siblings_till_sb=function(element){if(Vex.Log("count_measures_siblings_till_sb() {}"),0===element.length)return 0;switch($(element).prop("localName")){case"measure":return 1+count_measures_siblings_till_sb($(element).next());case"sb":return 0;default:return count_measures_siblings_till_sb($(element).next())}},update_measure_width=function(measure){n_measures=count_measures_siblings_till_sb(measure),measure_width=Math.round((width-system_left)/n_measures),Vex.LogDebug("update_measure_width(): "+n_measures+", width:"+measure_width)},startSystem=function(measure){update_measure_width(measure),Vex.LogDebug("startSystem() {enter}"),new_section?(nb_of_measures=0,measure_left=system_left,system_n+=1,system_top=bottom_most+SYSTEM_SPACE*(system_top>0?1:0),new_section=!1,system_break=!1,$.each(staffInfoArray,function(i,staff_info){staff_info&&(staff_info.renderWith.clef=!0,staff_info.renderWith.keysig=!0,staff_info.renderWith.timesig=!0)})):system_break&&(nb_of_measures=0,measure_left=system_left,system_n+=1,system_top=bottom_most+SYSTEM_SPACE,system_break=!1,$.each(staffInfoArray,function(i,staff_info){staff_info&&(staff_info.renderWith.clef=!0,staff_info.renderWith.keysig=!0)}))},moveOneMeasure=function(){if(measures[measures.length-1]){var previous_measure=measures[measures.length-1][0];measure_left=previous_measure.x+previous_measure.width,Vex.LogDebug("moveOneMeasure(): measure_left:"+measure_left)}else measure_left=system_left},atStartSystem=function(){return new_section||system_break},get_attr_value=function(element,attribute){var result=get_attr_value_opt(element,attribute);if(!result)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","Attribute "+attribute+" is mandatory.");return result},get_attr_value_opt=function(element,attribute){var result=$(element).attr(attribute);return result},mei_note2vex_key=function(mei_note){mei_note="number"==typeof mei_note&&2===arguments.length&&"object"==typeof arguments[1]?arguments[1]:mei_note;var pname=$(mei_note).attr("pname"),oct=$(mei_note).attr("oct");if(!pname||!oct)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.MissingAttribute","pname and oct attributes must be specified for <note>");return pname+"/"+oct},mei_syl2vex_annot=function(mei_note){var syl=$(mei_note).find("syl"),full_syl="";$(syl).each(function(i,s){var dash="i"==$(s).attr("wordpos")||"m"==$(s).attr("wordpos")?"-":"";full_syl+=(i>0?"\n":"")+$(s).text()+dash});"i"==syl.attr("wordpos")||"m"==syl.attr("wordpos")?"-":"";return full_syl},mei_dir2vex_annot=function(parent_measure,mei_note){var dir=$(parent_measure).find("dir"),dir_text="",pos="";return $(dir).each(function(){var startid=get_attr_value(this,"startid"),xml_id=get_attr_value(mei_note,"xml:id"),place=get_attr_value(this,"place");startid===xml_id&&(dir_text+=$(this).text().trim(),pos=place)}),[dir_text,pos]},mei_dur2vex_dur=function(mei_dur){if(mei_dur=String(mei_dur),"breve"===mei_dur)return void 0!=Vex.Flow.durationToTicks.durations[0]?"0":"w";if("1"===mei_dur)return"w";if("2"===mei_dur)return"h";if("4"===mei_dur)return"q";if("8"===mei_dur)return"8";if("16"===mei_dur)return"16";if("32"===mei_dur)return"32";if("64"===mei_dur)return"64";throw new Vex.RuntimeError("BadArguments",'The MEI duration "'+mei_dur+'" is not supported.')},mei_note2vex_dur=function(mei_note,allow_dotted){allow_dotted=allow_dotted||!0,mei_note="number"==typeof mei_note&&2===arguments.length&&"object"==typeof arguments[1]?arguments[1]:mei_note;var dur_attr=$(mei_note).attr("dur");void 0===dur_attr&&alert("Could not get duration from:\n"+JSON.stringify(mei_note,null,"	"));var dur=mei_dur2vex_dur(dur_attr);return allow_dotted===!0&&"1"===$(mei_note).attr("dots")&&(dur+="d"),dur},mei_accid2vex_accid=function(mei_accid){if("n"===mei_accid)return"n";if("f"===mei_accid)return"b";if("s"===mei_accid)return"#";if("ff"===mei_accid)return"bb";if("ss"===mei_accid)return"##";throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadAttributeValue","Invalid attribute value: "+mei_accid)},mei_note_stem_dir=function(mei_note){var given_dir=$(mei_note).attr("stem.dir");return"down"===given_dir?Vex.Flow.StaveNote.STEM_DOWN:"up"===given_dir?Vex.Flow.StaveNote.STEM_UP:void 0},mei_staffdef2vex_keyspec=function(mei_staffdef){if(void 0!==$(mei_staffdef).attr("key.pname")){var keyname=$(mei_staffdef).attr("key.pname").toUpperCase(),key_accid=$(mei_staffdef).attr("key.accid");if(void 0!==key_accid)switch(key_accid){case"s":keyname+="#";break;case"f":keyname+="b";break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.UnexpectedAttributeValue","Value of key.accid must be 's' or 'f'")}var key_mode=$(mei_staffdef).attr("key.mode");return void 0!==key_mode&&(keyname+="major"===key_mode?"":"m"),keyname}return"C"},mei_staffdef2vex_clef=function(mei_staffdef){var clef_shape=get_attr_value(mei_staffdef,"clef.shape"),clef_line=get_attr_value_opt(mei_staffdef,"clef.line"),clef_dis=get_attr_value_opt(mei_staffdef,"clef.dis"),clef_dis_place=get_attr_value_opt(mei_staffdef,"clef.dis.place");if("G"!==clef_shape||clef_line&&"2"!==clef_line){if("F"!==clef_shape||clef_line&&"4"!==clef_line){if("C"===clef_shape&&"3"===clef_line)return"alto";if("C"===clef_shape&&"4"===clef_line)return"tenor";throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported",'Clef definition is not supported: [ clef.shape="'+clef_shape+'" '+(clef_line?'clef.line="'+clef_line+'"':"")+" ]")}return"bass"}return"8"===clef_dis&&"below"===clef_dis_place&&void 0!=Vex.Flow.clefProperties.values.octave?"octave":"treble"},staff_clef=function(staff_n){if(staff_n>=staffInfoArray.length)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.staff_clef():E01","No staff definition for staff n="+staff_n);var staffdef=staffInfoArray[staff_n].staffDef;return mei_staffdef2vex_clef(staffdef)},mei_staffdef2vex_timespec=function(mei_staffdef){return void 0!==$(mei_staffdef).attr("meter.count")&&void 0!==$(mei_staffdef).attr("meter.unit")?$(mei_staffdef).attr("meter.count")+"/"+$(mei_staffdef).attr("meter.unit"):void 0},initialise_score=function(target){var renderer=new Vex.Flow.Renderer(target,backend||Vex.Flow.Renderer.Backends.CANVAS);context=renderer.getContext()},staff_height=function(){return 100},staff_top_rel=function(staff_n){var i,result=0;for(i=0;i<staffDefList.length&&$(staffDefList[i]).attr("n")!==staff_n.toString();i++)result+=staff_height(i);return result},staff_top_abs=function(staff_n){var result=system_top+staff_top_rel(staff_n),bottom_most_candidate=result+staff_height(staff_n);return bottom_most_candidate>bottom_most&&(bottom_most=bottom_most_candidate),result},initialise_staff_n=function(staff_n,width,left_barline,right_barline){if(!staff_n)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArgument",'Cannot render staff without attribute "n".');var staffdef=staffInfoArray[staff_n].staffDef,staff=new Vex.Flow.Stave(measure_left,staff_top_abs(staff_n),width);return staffInfoArray[staff_n].renderWith.clef&&("true"===$(staffdef).attr("clef.visible")||void 0===$(staffdef).attr("clef.visible"))&&(staff.addClef(mei_staffdef2vex_clef(staffdef)),staffInfoArray[staff_n].renderWith.clef=!1),staffInfoArray[staff_n].renderWith.keysig&&(("true"===$(staffdef).attr("key.sig.show")||void 0===$(staffdef).attr("key.sig.show"))&&staff.addKeySignature(mei_staffdef2vex_keyspec(staffdef)),staffInfoArray[staff_n].renderWith.keysig=!1),staffInfoArray[staff_n].renderWith.timesig&&(("norm"===$(staffdef).attr("meter.rend")||void 0===$(staffdef).attr("meter.rend"))&&staff.addTimeSignature(mei_staffdef2vex_timespec(staffdef)),staffInfoArray[staff_n].renderWith.timesig=!1),left_barline&&staff.setBegBarType(mei2vexflowTables.barlines[left_barline]),right_barline&&staff.setEndBarType(mei2vexflowTables.barlines[right_barline]),staff.setContext(context).draw(),staffXShift=staff.getModifierXShift(),Vex.LogDebug("initialise_staff_n(): staffXShift="+staffXShift),staff},render_measure_wise=function(){var scoredef=$(score).find("scoreDef")[0];if(!scoredef)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadMEIFile","No <scoreDef> found.");process_scoreDef(scoredef),$(score).find("section").children().each(process_section_child),$.each(beams,function(i,beam){beam.setContext(context).draw()}),render_vexTies(ties),render_vexTies(slurs),render_vexHairpins(hairpins)},render_vexTies=function(eventlinks){$(eventlinks).each(function(i,link){var f_vexNote,f_note=notes_by_id[link.getFirstId()],l_note=notes_by_id[link.getLastId()];f_note&&(f_vexNote=f_note.vexNote);var l_vexNote;l_note&&(l_vexNote=l_note.vexNote),new Vex.Flow.StaveTie({first_note:f_vexNote,last_note:l_vexNote}).setContext(context).draw()})},render_vexHairpins=function(hairpin_links){$(hairpin_links).each(function(i,link){var f_vexNote,f_note=notes_by_id[link.getFirstId()],l_note=notes_by_id[link.getLastId()];f_note&&(f_vexNote=f_note.vexNote);var l_vexNote;l_note&&(l_vexNote=l_note.vexNote);var place=mei2vexflowTables.positions[link.params.place],type=mei2vexflowTables.hairpins[link.params.form],l_ho=0,r_ho=0,hairpin_options={height:10,y_shift:0,left_shift_px:l_ho,r_shift_px:r_ho};new Vex.Flow.StaveHairpin({first_note:f_vexNote,last_note:l_vexNote},type).setContext(context).setRenderOptions(hairpin_options).setPosition(place).draw()})},draw_stave_connectors=function(){for(var first_last in staveConnectors){var staveConn=staveConnectors[first_last],vexType=staveConn.vexType(),top_staff=staves_by_n[staveConn.top_staff_n],bottom_staff=staves_by_n[staveConn.bottom_staff_n];if(vexType&&top_staff&&bottom_staff){var vexConnector=new Vex.Flow.StaveConnector(top_staff,bottom_staff);vexConnector.setType(staveConn.vexType()),vexConnector.setContext(context),vexConnector.draw()}}},process_section_child=function(i,child){switch($(child).prop("localName")){case"measure":var need_connectors;atStartSystem()?(startSystem(child),need_connectors=!0):(moveOneMeasure(),need_connectors=!1),staveVoices.reset(),extract_staves(child),need_connectors&&(draw_stave_connectors(),need_connectors=!1),staveVoices.format(measure_width-staffXShift-20),staveVoices.draw(context,staves_by_n),extract_linkingElements(child,"tie",ties),extract_linkingElements(child,"slur",slurs),extract_linkingElements(child,"hairpin",hairpins);break;case"scoreDef":process_scoreDef(child);break;case"staffDef":process_staffDef(child);break;case"sb":process_systemBreak(child);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(child).prop("localName")+"> is not supported in <section>")}},process_systemBreak=function(){system_break=!0},process_scoreDef=function(scoredef){staffDefList.length=0,$(scoredef).children().each(process_scoredef_child)},process_scoredef_child=function(i,child){switch($(child).prop("localName")){case"staffGrp":process_staffGrp(child);break;default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(child).prop("localName")+"> is not supported in <scoreDef>")}},process_staffGrp=function(staffGrp){var result={},symbol=staffGrp.attrs().symbol;return $(staffGrp).children().each(function(i,child){var local_result=process_staffGrp_child(i,child);Vex.LogDebug("process_staffGrp() {1}.{a}: local_result.first_n:"+local_result.first_n+" local_result.last_n:"+local_result.last_n),0===i?(result.first_n=local_result.first_n,result.last_n=local_result.last_n):result.last_n=local_result.last_n}),Vex.LogDebug("process_staffGrp() {2}: symbol:"+symbol+" result.first_n:"+result.first_n+" result.last_n:"+result.last_n),staveConnectors[result.first_n.toString()+":"+result.last_n.toString()]=new MEI2VF.StaveConnector(symbol,result.first_n,result.last_n),result},process_staffGrp_child=function(i,child){switch($(child).prop("localName")){case"staffDef":var staff_n=process_staffDef(child);return{first_n:staff_n,last_n:staff_n};case"staffGrp":return process_staffGrp(child);default:throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.NotSupported","Element <"+$(child).prop("localName")+"> is not supported in <staffGrp>")}},process_staffDef=function(staffDef){var staff_n=Number(staffDef.attrs().n),staff_info=staffInfoArray[staff_n];return staff_info?staffInfoArray[staff_n].updateDef(staffDef):staffInfoArray[staff_n]=new MEI2VF.StaffInfo(staffDef,!0,!0,!0),staffDefList.push(staffDef),staff_n},extract_staves=function(measure){measures.push($(measure).find("staff").map(function(i,staff){return extract_layers(i,staff,measure)}).get())},extract_layers=function(i,staff_element,parent_measure){var staff,staff_n=Number(staff_element.attrs().n),measure_n=Number(parent_measure.attrs().n),left_barline=parent_measure.getAttribute("left"),right_barline=parent_measure.getAttribute("right");staff=initialise_staff_n(staff_n,measure_width,left_barline,right_barline);var layer_events=$(staff_element).find("layer").map(function(i,layer){return extract_events(i,layer,staff_element,parent_measure)}).get();return $(layer_events).each(function(){var events=$(this.events).get().map(function(events){return events.vexNote?events.vexNote:events});staveVoices.addVoice(make_voice(null,events),staff_n)}),staves_by_n[staff_n]=staff,void 0===measures_by_n[measure_n]&&(measures_by_n[measure_n]=[]),measures_by_n[measure_n][staff_n]=staff,staff},extract_events=function(i,layer,parent_staff_element,parent_measure){var measure_n=parent_measure.attrs().n;if(!measure_n)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_events:","<measure> must have @n specified");var staff_n=parent_staff_element.attrs().n;staff_n||(staff_n="1");var layer_n=layer.attrs().n;layer_n||(layer_n="1");var staffdef=staffInfoArray[staff_n].staffDef,refLocationIndex=measure_n+":"+staff_n+":"+layer_n;return unresolvedTStamp2[refLocationIndex]&&($(unresolvedTStamp2[refLocationIndex]).each(function(i,eventLink){var count=$(staffdef).attr("meter.count"),unit=$(staffdef).attr("meter.unit"),meter={count:Number(count),unit:Number(unit)};eventLink.setContext({layer:layer,meter:meter}),unresolvedTStamp2[refLocationIndex][i]=null}),unresolvedTStamp2[refLocationIndex]=null),{layer:i,events:$(layer).children().map(function(i,element){return process_element(element,layer,parent_staff_element,parent_measure)}).get()}},extract_linkingElements=function(measure,element_name,eventlink_container){var link_staffInfo=function(lnkelem){var staff_n=lnkelem.attrs().staff;staff_n||(staff_n="1");var layer_n=lnkelem.attrs().layer;return layer_n||(layer_n="1"),{staff_n:staff_n,layer_n:layer_n}},local_tstamp2id=function(tstamp,lnkelem,measure){var stffinf=link_staffInfo(lnkelem),staff=$(measure).find('staff[n="'+stffinf.staff_n+'"]'),layer=$(staff).find('layer[n="'+stffinf.layer_n+'"]').get(0);if(!layer){var layer_candid=$(staff).find("layer");if(layer_candid&&!layer_candid.attr("n")&&(layer=layer_candid),!layer)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E01","Cannot find layer")}var staffdef=staffInfoArray[stffinf.staff_n].staffDef;if(!staffdef)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E02","Cannot determine staff definition.");var meter={count:Number(staffdef.attrs()["meter.count"]),unit:Number(staffdef.attrs()["meter.unit"])};if(!meter.count||!meter.unit)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.extract_linkingElements:E03","Cannot determine meter; missing or incorrect @meter.count or @meter.unit.");
return MeiLib.tstamp2id(tstamp,layer,meter)},measure_partOf=function(tstamp2){return tstamp2.substring(0,tstamp2.indexOf("m"))},beat_partOf=function(tstamp2){return tstamp2.substring(tstamp2.indexOf("+")+1)},link_elements=$(measure).find(element_name);$.each(link_elements,function(i,lnkelem){var eventLink=new MEI2VF.EventLink(null,null);if("hairpin"===element_name){var form=lnkelem.attrs().form;if(!form)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:extract_linkingElements","@form is mandatory in <hairpin> - make sure the xml is valid.");var place=lnkelem.attrs().place;eventLink.setParams({form:form,place:place})}var startid=lnkelem.attrs().startid;if(startid)eventLink.setFirstId(startid);else{var tstamp=lnkelem.attrs().tstamp;tstamp&&(startid=local_tstamp2id(tstamp,lnkelem,measure),eventLink.setFirstId(startid))}var endid=lnkelem.attrs().endid;if(endid)eventLink.setLastId(endid);else{var tstamp2=lnkelem.attrs().tstamp2;if(tstamp2){var measures_ahead=Number(measure_partOf(tstamp2));if(measures_ahead>0){eventLink.setLastTStamp(beat_partOf(tstamp2));var staffinfo=link_staffInfo(lnkelem),measure_n=measure.attrs().n,tartget_measure_n=Number(measure_n)+measures_ahead,refLocationIndex=tartget_measure_n.toString()+":"+staffinfo.staff_n+":"+staffinfo.layer_n;unresolvedTStamp2[refLocationIndex]||(unresolvedTStamp2[refLocationIndex]=new Array),unresolvedTStamp2[refLocationIndex].push(eventLink)}else endid=local_tstamp2id(beat_partOf(tstamp2),lnkelem,measure),eventLink.setLastId(endid)}}eventlink_container.push(eventLink)})},start_tieslur=function(startid,linkCond,container){var eventLink=new MEI2VF.EventLink(startid,null);eventLink.setParams({linkCond:linkCond}),container.push(eventLink)},terminate_tie=function(endid,linkCond){var cmpLinkCond=function(lc1,lc2){return lc1&&lc2&&lc1.pname===lc2.pname&&lc1.oct===lc2.oct&&lc1.system===lc2.system};if(!linkCond.pname||!linkCond.oct)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:TermTie01","no pitch or specified for the tie");var i,tie,found=!1;for(i=0;!found&&i<ties.length;++i)tie=ties[i],tie.getLastId()||cmpLinkCond(tie.params.linkCond,linkCond)&&(found=!0,tie.setLastId(endid));if(!found){var tie=new MEI2VF.EventLink(null,endid);ties.push(tie)}},terminate_slur=function(endid,linkCond){var cmpLinkCond=function(lc1,lc2){return lc1.nesting_level===lc2.nesting_level&&lc1.system===lc2.system},found=!1,i=0;for(i=0;!found&&i<slurs.length;++i){var slr=slurs[i];slr&&!slr.getLastId()&&cmpLinkCond(slr.params.linkCond,linkCond)&&(found=!0,slr.setLastId(endid))}if(!found){var slr=new MEI2VF.EventLink(null,endid);slurs.push(slr)}},parse_slur_attribute=function(slur_str){var result=[],numbered_tokens=slur_str.split(" ");return $.each(numbered_tokens,function(i,numbered_token){var num;if(1===numbered_token.length)result.push({letter:numbered_token,nesting_level:0});else{if(2!==numbered_token.length)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");if(!(num=Number(numbered_token[1])))throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments:ParseSlur01","badly formed slur attribute");result.push({letter:numbered_token[0],nesting_level:num})}}),result},make_note=function(element,parent_layer,parent_staff_element,parent_measure){var make_annot_below=function(text){return new Vex.Flow.Annotation(text).setFont("Times",ANNOT_FONT_SIZE).setBottom(!0)},make_annot_above=function(text){return new Vex.Flow.Annotation(text).setFont("Times",ANNOT_FONT_SIZE)};try{var note_opts={keys:[mei_note2vex_key(element)],clef:staff_clef($(parent_staff_element).attr("n")),duration:mei_note2vex_dur(element)},specified_stem_direction=mei_note_stem_dir(element);specified_stem_direction?note_opts.stem_direction=specified_stem_direction:note_opts.auto_stem=!0;var note=new Vex.Flow.StaveNote(note_opts);note.addAnnotation(2,make_annot_below(mei_syl2vex_annot(element)));var annot=mei_dir2vex_annot(parent_measure,element);note.addAnnotation(2,"below"==annot[1]?make_annot_below(annot[0]):make_annot_above(annot[0]));try{var i,dots=parseInt($(element).attr("dots"));for(i=0;dots>i;i++)note.addDotToAll()}catch(x){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the dots of <note>: "+JSON.stringify(element.attrs())+'. "'+x.toString()+'"')}var mei_accid=$(element).attr("accid");mei_accid&&note.addAccidental(0,new Vex.Flow.Accidental(mei_accid2vex_accid(mei_accid))),$.each($(element).find("artic"),function(i,ar){note.addArticulation(0,new Vex.Flow.Articulation(mei2vexflowTables.articulations[$(ar).attr("artic")]).setPosition(mei2vexflowTables.positions[$(ar).attr("place")]))}),$.each($(element).children(),function(i,child){$(child).remove()});var pname=$(element).attr("pname");if(!pname)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have pname attribute");var oct=$(element).attr("oct");if(!oct)throw new MEI2VF.RUNTIME_ERROR("MEI2VF.RERR.BadArguments","mei:note must have oct attribute");var xml_id=$(element).attr("xml:id");xml_id||(xml_id=MeiLib.createPseudoUUID(),$(element).attr("xml:id",xml_id));var mei_tie=$(element).attr("tie");mei_tie||(mei_tie="");for(var i=0;i<mei_tie.length;++i)switch(mei_tie[i]){case"i":start_tieslur(xml_id,{pname:pname,oct:oct,system:system_n},ties);break;case"t":terminate_tie(xml_id,{pname:pname,oct:oct,system:system_n})}var mei_slur=$(element).attr("slur");if(mei_slur){var tokens=parse_slur_attribute(mei_slur);$.each(tokens,function(i,token){switch(token.letter){case"i":start_tieslur(xml_id,{nesting_level:token.nesting_level,system:system_n},slurs);break;case"t":terminate_slur(xml_id,{nesting_level:token.nesting_level,system:system_n})}})}var note_object={vexNote:note,id:xml_id};return notes.push(note_object),notes_by_id[xml_id]={meiNote:element,vexNote:note},note_object}catch(x){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <note>: "+JSON.stringify(element.attrs())+'. "'+x.toString()+'"')}},make_rest=function(element,parent_layer,parent_staff_element,parent_measure,visible){void 0==visible&&(visible=!0);try{if(visible){var dur=mei_note2vex_dur(element,!1),rest=new Vex.Flow.StaveNote({keys:["w"===dur?"d/5":"b/4"],duration:dur+"r"});"1"===$(element).attr("dots")&&rest.addDotToAll()}else var rest=new Vex.Flow.GhostNote({duration:mei_note2vex_dur(element,!1)+"r"});return rest}catch(x){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <rest>: "+JSON.stringify(element.attrs())+'. "'+x.toString()+'"')}},make_mrest=function(element){try{var mrest=new Vex.Flow.StaveNote({keys:["d/5"],duration:"wr"});return mrest}catch(x){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <mRest>: "+JSON.stringify(element.attrs())+'. "'+x.toString()+'"')}},make_beam=function(element,parent_layer,parent_staff_element,parent_measure){var elements=$(element).children().map(function(i,note){var proc_element=process_element(note,parent_layer,parent_staff_element,parent_measure);return proc_element.vexNote?proc_element.vexNote:proc_element}).get();return beams.push(new Vex.Flow.Beam(elements)),elements},make_chord=function(element,parent_layer,parent_staff_element){try{var keys=$(element).children().map(mei_note2vex_key).get(),duration=mei_dur2vex_dur(Math.max.apply(Math,$(element).children().map(function(){return Number($(this).attr("dur"))}).get())),dotted=$(element).children().map(function(){return"1"===$(this).attr("dots")}).get().any();dotted===!0&&(duration+="d");var chord_opts={keys:keys,clef:staff_clef($(parent_staff_element).attr("n")),duration:duration},specified_stem_direction=mei_note_stem_dir(element);specified_stem_direction?chord_opts.stem_direction=specified_stem_direction:chord_opts.auto_stem=!0;var chord=new Vex.Flow.StaveNote(chord_opts);return dotted===!0&&chord.addDotToAll(),$(element).children().each(function(i,note){var mei_accid=$(note).attr("accid");void 0!==mei_accid&&chord.addAccidental(i,new Vex.Flow.Accidental(mei_accid2vex_accid(mei_accid)))}),chord}catch(x){throw new Vex.RuntimeError("BadArguments","A problem occurred processing the <chord>:"+x.toString())}},process_element=function(element,parent_layer,parent_staff_element,parent_measure){var element_type=$(element).prop("localName");if("rest"===element_type)return make_rest(element,parent_layer,parent_staff_element,parent_measure);if("mRest"===element_type)return make_mrest(element,parent_layer,parent_staff_element,parent_measure);if("space"===element_type)return make_rest(element,parent_layer,parent_staff_element,parent_measure,!1);if("note"===element_type)return make_note(element,parent_layer,parent_staff_element,parent_measure);if("beam"===element_type)return make_beam(element,parent_layer,parent_staff_element,parent_measure);if("chord"===element_type)return make_chord(element,parent_layer,parent_staff_element,parent_measure);throw new Vex.RuntimeError("BadArguments",'Rendering of element "'+element_type+'" is not supported.')},make_voice=function(i,voice_contents){if(!$.isArray(voice_contents))throw new Vex.RuntimeError("BadArguments","make_voice() voice_contents argument must be an array.");var voice=new Vex.Flow.Voice({num_beats:Number($(score).find("staffDef").attr("meter.count")),beat_value:Number($(score).find("staffDef").attr("meter.unit")),resolution:Vex.Flow.RESOLUTION});return voice.setStrict(!1),voice.addTickables(voice_contents),voice};initialise_score(target),render_measure_wise(),MEI2VF.rendered_measures=measures_by_n},MEI2VF.EventLink=function(first_id,last_id){this.init(first_id,last_id)},MEI2VF.EventLink.prototype.init=function(first_id,last_id){this.first_ref=new MEI2VF.EventReference(first_id),this.last_ref=new MEI2VF.EventReference(last_id),this.params={}},MEI2VF.EventLink.prototype.setParams=function(params){this.params=params},MEI2VF.EventLink.prototype.setFirstRef=function(first_ref){this.first_ref=first_ref},MEI2VF.EventLink.prototype.setLastRef=function(last_ref){this.last_ref=last_ref},MEI2VF.EventLink.prototype.setFirstId=function(id){this.first_ref.setId(id)},MEI2VF.EventLink.prototype.setLastId=function(id){this.last_ref.setId(id)},MEI2VF.EventLink.prototype.setFirstTStamp=function(tstamp){this.first_ref.setTStamp(tstamp)},MEI2VF.EventLink.prototype.setLastTStamp=function(tstamp2){this.last_ref.setTStamp(tstamp2)},MEI2VF.EventLink.prototype.setContext=function(meicontext){this.meicontext=meicontext},MEI2VF.EventLink.prototype.getFirstId=function(){return this.first_ref.getId({meicontext:this.meicontext})},MEI2VF.EventLink.prototype.getLastId=function(){return this.last_ref.getId({meicontext:this.meicontext})},MEI2VF.EventReference=function(xmlid){this.xmlid=xmlid},MEI2VF.EventReference.prototype.setId=function(xmlid){this.xmlid=xmlid},MEI2VF.EventReference.prototype.setTStamp=function(tstamp){this.tstamp=tstamp,this.xmlid&&this.tryResolveReference(!0)},MEI2VF.EventReference.prototype.tryResolveReference=function(){{var tstamp=this.tstamp;this.meicontext}if(!tstamp)throw new MEI2VF.RUNTIME_ERROR("MEI2VF:RERR:BADARG:EventRef001","EventReference: tstamp must be set in order to resolve reference.");this.xmlid=this.meicontext?MeiLib.tstamp2id(this.tstamp,this.meicontext.layer,this.meicontext.meter):null},MEI2VF.EventReference.prototype.getId=function(params){return params&&params.meicontext&&this.setContext(params.meicontext),this.xmlid?this.xmlid:this.tstamp&&this.meicontext?(this.tryResolveReference(params&&params.strict),this.xmlid):null},MEI2VF.EventReference.prototype.setContext=function(meicontext){this.meicontext=meicontext},MEI2VF.StaffInfo=function(staffdef,w_clef,w_keysig,w_timesig){this.renderWith={clef:w_clef,keysig:w_keysig,timesig:w_timesig},this.staffDef=staffdef},MEI2VF.StaffInfo.prototype.look4changes=function(current_staffDef,new_staffDef){var result={clef:!1,keysig:!1,timesig:!1};if(!current_staffDef&&new_staffDef)return result.clef=!0,result.keysig=!0,result.keysig=!0,result;if(current_staffDef&&!new_staffDef)return result.clef=!1,result.keysig=!1,result.keysig=!1,result;if(!current_staffDef&&!new_staffDef)throw new MEI2VF_RUNTIME_ERROR("BadArgument","Cannot compare two undefined staff definitions.");var cmp_attr=function(e1,e2,attr_name){return $(e1).attr(attr_name)===$(e2).attr(attr_name)};return cmp_attr(current_staffDef,new_staffDef,"clef.shape")&&cmp_attr(current_staffDef,new_staffDef,"clef.line")||(result.clef=!0),cmp_attr(current_staffDef,new_staffDef,"key.pname")&&cmp_attr(current_staffDef,new_staffDef,"key.accid")&&cmp_attr(current_staffDef,new_staffDef,"key.mode")||(result.keysig=!0),cmp_attr(current_staffDef,new_staffDef,"meter.count")&&cmp_attr(current_staffDef,new_staffDef,"meter.unit")||(result.timesig=!0),result},MEI2VF.StaffInfo.prototype.updateDef=function(staffdef){this.renderWith=this.look4changes(this.staffDef,staffdef),this.staffDef=staffdef},MEI2VF.StaveConnector=function(symbol,top_staff_n,bottom_staff_n){this.init(symbol,top_staff_n,bottom_staff_n)},MEI2VF.StaveConnector.prototype.init=function(symbol,top_staff_n,bottom_staff_n){this.symbol=symbol,this.top_staff_n=top_staff_n,this.bottom_staff_n=bottom_staff_n},MEI2VF.StaveConnector.prototype.vexType=function(){switch(this.symbol){case"line":return Vex.Flow.StaveConnector.type.SINGLE;case"brace":return Vex.Flow.StaveConnector.type.BRACE;case"bracket":return Vex.Flow.StaveConnector.type.BRACKET;case"none":return null;default:return Vex.Flow.StaveConnector.type.SINGLE}},MEI2VF.StaffVoice=function(voice,staff_n){this.voice=voice,this.staff_n=staff_n},MEI2VF.StaveVoices=function(){this.all_voices=new Array},MEI2VF.StaveVoices.prototype.addStaffVoice=function(staffVoice){this.all_voices.push(staffVoice)},MEI2VF.StaveVoices.prototype.addVoice=function(voice,staff_n){this.addStaffVoice(new MEI2VF.StaffVoice(voice,staff_n))},MEI2VF.StaveVoices.prototype.reset=function(){this.all_voices=[]},MEI2VF.StaveVoices.prototype.format=function(width){var voices=$.map(this.all_voices,function(staffVoice){return staffVoice.voice});(new Vex.Flow.Formatter).format(voices,width)},MEI2VF.StaveVoices.prototype.draw=function(context,staves){for(var staffVoice,all_voices=this.all_voices,i=0;i<all_voices.length;++i)staffVoice=all_voices[i],staffVoice.voice.draw(context,staves[staffVoice.staff_n])};